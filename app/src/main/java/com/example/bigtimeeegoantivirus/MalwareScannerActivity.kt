package com.example.bigtimeeegoantivirus

import android.os.Bundle
import android.view.View
import android.widget.Button
import android.widget.ProgressBar
import android.widget.TextView
import androidx.appcompat.app.AppCompatActivity
import okhttp3.*
import org.json.JSONObject
import java.io.IOException

class MalwareScannerActivity : AppCompatActivity() {

    private lateinit var tvScanStatus: TextView
    private lateinit var tvScanResult: TextView
    private lateinit var progressBar: ProgressBar
    private lateinit var btnStartScan: Button
    private val client = OkHttpClient()

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_malware_scanner)

        tvScanStatus = findViewById(R.id.tvScanStatus)
        tvScanResult = findViewById(R.id.tvScanResult)
        progressBar = findViewById(R.id.progressBar)
        btnStartScan = findViewById(R.id.btnStartScan)

        btnStartScan.setOnClickListener {
            startMalwareScan()
        }
    }

    private fun startMalwareScan() {
        tvScanStatus.text = "Scanning..."
        progressBar.visibility = View.VISIBLE
        tvScanResult.visibility = View.GONE
        btnStartScan.isEnabled = false


        val apiKey = "870df8edc61e52371c259645ea8370a766b29310d4b6e827f95deff7de35486d"
        val fileHash = "8a6cd58c194295df3938df8d3ddd043a39f24e342b5407b814a7b532a952e5b4"
        val url = "https://www.virustotal.com/api/v3/files/$fileHash"

        val request = Request.Builder()
            .url(url)
            .addHeader("x-apikey", apiKey)
            .build()

        client.newCall(request).enqueue(object : Callback {
            override fun onFailure(call: Call, e: IOException) {
                runOnUiThread {
                    tvScanStatus.text = "Scan Failed"
                    progressBar.visibility = View.GONE
                    btnStartScan.isEnabled = true
                }
            }

            override fun onResponse(call: Call, response: Response) {
                response.body?.let { responseBody ->
                    val responseData = responseBody.string()
                    val json = JSONObject(responseData)

                    val scanResults = json.optJSONObject("data")?.optJSONObject("attributes")
                        ?.optJSONObject("last_analysis_stats")

                    val malicious = scanResults?.optInt("malicious", 0) ?: 0

                    runOnUiThread {
                        tvScanStatus.text = "Scan Complete"
                        progressBar.visibility = View.GONE
                        btnStartScan.isEnabled = true  // Re-enable button
                        tvScanResult.visibility = View.VISIBLE
                        tvScanResult.text = "Malware Detections: $malicious"
                    }
                }
            }
        })
    }
}

